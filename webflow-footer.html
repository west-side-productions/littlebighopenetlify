<!-- LBH Core Functionality -->
<script>
(function() {
    // Only proceed if $lbh hasn't been initialized
    if (typeof window.$lbh !== 'undefined') {
        console.log('LBH already initialized');
        return;
    }

    // Initialize LBH namespace
    window.$lbh = {
        config: {
            supportedLanguages: ['de', 'en', 'fr', 'it'],
            defaultLanguage: 'de'
        },

        // Language detection with caching
        language: (function() {
            let cachedLanguage = null;
            return function() {
                if (cachedLanguage) return cachedLanguage;
                
                try {
                    if (!navigator.language) return this.config.defaultLanguage;
                    const langPart = navigator.language.split('-')[0].toLowerCase();
                    cachedLanguage = this.config.supportedLanguages.includes(langPart) ? 
                        langPart : this.config.defaultLanguage;
                    return cachedLanguage;
                } catch (e) {
                    console.warn('Language detection error:', e);
                    return this.config.defaultLanguage;
                }
            };
        })(),

        // Storage methods with improved error handling
        storage: {
            get: function(key, defaultValue = {}) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : defaultValue;
                } catch (e) {
                    console.warn('Storage get error:', e);
                    return defaultValue;
                }
            },
            set: function(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.warn('Storage set error:', e);
                    return false;
                }
            }
        }
    };

    // Initialize system with improved error handling
    async function init() {
        try {
            console.log('Initializing LBH system...');
            
            // Handle language redirect for root path
            if (location.pathname === "/") {
                const lang = window.$lbh.language();
                if (lang !== "de") {
                    const target = `${location.origin}/${lang}/`;
                    console.log("Language redirect:", target);
                    location.href = target;
                    return;
                }
            }

        } catch (error) {
            console.error('Initialization error:', error);
            // Continue with degraded functionality
        }
    }

    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { passive: true });
    } else {
        init();
    }
})();
</script>
