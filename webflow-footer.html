<!-- LBH Core Functionality -->
<script>
"use strict";

const $lbh = {
    memberStackAvailable: !(typeof $memberstackDom === "undefined"),
    language: () => {
        const defaultLang = "de";
        const langs = ["de", "en", "fr", "it"];
        try {
            if (!navigator.language) return defaultLang;
            const langPart = navigator.language.split('-')[0];
            if (!langPart) return defaultLang;
            const i = langs.indexOf(langPart.toLowerCase());
            return i >= 0 ? langs[i] : defaultLang;
        } catch (e) {
            console.error('Error detecting language:', e);
            return defaultLang;
        }
    },
    loadJson: async function loadJson() {
        if (!$lbh.memberStackAvailable) {
            return JSON.parse(localStorage.getItem("json") ?? "{}");
        }
        let json = await $memberstackDom.getMemberJSON();
        console.log("json", json);
        return json?.data ?? {};
    },
    updateJson: async function updateJson(json) {
        if (!$lbh.memberStackAvailable) {
            localStorage.setItem("json", JSON.stringify(json));
            return;
        }
        const up = { json: json };
        console.log("json", up);
        await $memberstackDom.updateMemberJSON(up);
    },
    tryfind: function tryfind(selector, parent) {
        return (parent ?? document).querySelector(selector);
    },
    find: function find(selector, parent) {
        const res = $lbh.tryfind(selector, parent);
        if (!res) {
            throw new Error(`Can't find element by selector '${selector}' in ${parent ?? document}`);
        }
        return res;
    },
    formatQuantity: function formatQuantity(q) {
        if (!q) return "";
        let nr = Math.floor(q);
        let fract = q - nr;
        switch (fract) {
            case 0: fract = ""; break;
            case 0.25: fract = "¼"; break;
            case 0.5: fract = "½"; break;
        }
        return nr > 0 ? `${nr}${fract}` : fract;
    }
};

if (!$lbh.memberStackAvailable) {
    console.warn("NO MEMBERSTACK AVAILABLE, using localStorage");
}

// Language redirect
if (location.pathname == "/") {
    const lang = $lbh.language();
    if (lang != "de") {
        const target = `${location.origin}/${lang}/`;
        console.log("lang-switch", target);
        location.href = target;
    }
}
</script>

<!-- Email Verification Handler -->
<script>
console.log('Initializing LBH verification system...');

async function handleVerification() {
    // Only handle /verify path specifically
    if (window.location.pathname !== '/verify') return;
    
    console.log('Starting verification process');
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    
    if (!token) {
        console.error('No token found in URL parameters:', window.location.search);
        window.location.href = '/verification-error?message=Missing token';
        return;
    }

    try {
        console.log('Attempting verification with token');
        
        // Wait for MemberStack to be available
        let attempts = 0;
        while (!window.MemberStack && attempts < 20) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
            console.log('Waiting for MemberStack, attempt:', attempts);
        }

        if (!window.MemberStack) {
            throw new Error('MemberStack not available');
        }

        // Use standard MemberStack v1 verification
        await window.MemberStack.onReady.then(async function(MS) {
            await MS.verifyEmail(token);
        });

        // Get language for redirect
        const lang = $lbh.language();
        window.location.href = lang === 'de' ? '/verification-success' : `/${lang}/verification-success`;
        
    } catch (error) {
        console.error('Verification error:', error);
        const lang = $lbh.language();
        const errorPath = lang === 'de' ? '/verification-error' : `/${lang}/verification-error`;
        const errorMessage = error?.message || 'Verification failed';
        window.location.href = `${errorPath}?message=${encodeURIComponent(errorMessage)}`;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, checking for verification...');
    handleVerification();
});
</script>
