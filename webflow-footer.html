<!-- LBH Core Functionality -->
<script>
"use strict";

const $lbh = {
    memberStackAvailable: false,
    
    waitForMemberstack: function(timeout = 10000) {
        return new Promise((resolve, reject) => {
            if (window.memberstack) {
                resolve(window.memberstack);
                return;
            }

            const timeoutId = setTimeout(() => {
                reject(new Error('Memberstack initialization timeout'));
            }, timeout);

            document.addEventListener('memberstack:ready', () => {
                clearTimeout(timeoutId);
                resolve(window.memberstack);
            });
        });
    },

    language: () => {
        const defaultLang = "de";
        const langs = ["de", "en", "fr", "it"];
        try {
            if (!navigator.language) return defaultLang;
            const langPart = navigator.language.split('-')[0];
            if (!langPart) return defaultLang;
            const i = langs.indexOf(langPart.toLowerCase());
            return i >= 0 ? langs[i] : defaultLang;
        } catch (e) {
            console.error('Error detecting language:', e);
            return defaultLang;
        }
    },
    loadJson: async function loadJson() {
        if (!$lbh.memberStackAvailable) {
            console.warn("NO MEMBERSTACK AVAILABLE, using localStorage", {
                memberstack: !!window.memberstack,
                memberstackDom: !!window.$memberstackDom,
                location: window.location.href
            });
            return JSON.parse(localStorage.getItem("json") ?? "{}");
        }
        try {
            const MS = await $lbh.waitForMemberstack();
            const member = await MS.getMemberJSON();
            console.log("Member data:", member);
            return member?.data ?? {};
        } catch (e) {
            console.error('Error loading member data:', e);
            return {};
        }
    },
    updateJson: async function updateJson(json) {
        if (!$lbh.memberStackAvailable) {
            console.warn("NO MEMBERSTACK AVAILABLE, using localStorage", {
                memberstack: !!window.memberstack,
                memberstackDom: !!window.$memberstackDom,
                location: window.location.href
            });
            localStorage.setItem("json", JSON.stringify(json));
            return;
        }
        try {
            const MS = await $lbh.waitForMemberstack();
            await MS.updateMemberJSON({ json: json });
        } catch (e) {
            console.error('Error updating member data:', e);
            localStorage.setItem("json", JSON.stringify(json)); // Fallback to localStorage
        }
    },
    tryfind: function tryfind(selector, parent) {
        return (parent ?? document).querySelector(selector);
    },
    find: function find(selector, parent) {
        const res = $lbh.tryfind(selector, parent);
        if (!res) {
            throw new Error(`Can't find element by selector '${selector}' in ${parent ?? document}`);
        }
        return res;
    },
    formatQuantity: function formatQuantity(q) {
        if (!q) return "";
        let nr = Math.floor(q);
        let fract = q - nr;
        switch (fract) {
            case 0: fract = ""; break;
            case 0.25: fract = "¼"; break;
            case 0.5: fract = "½"; break;
        }
        return nr > 0 ? `${nr}${fract}` : fract;
    }
};

// Initialize Memberstack
(async function initializeMemberstack() {
    try {
        console.log('Initializing Memberstack...');
        await $lbh.waitForMemberstack();
        $lbh.memberStackAvailable = true;
        console.log('Memberstack initialized successfully');
    } catch (error) {
        console.error('Failed to initialize Memberstack:', error);
        $lbh.memberStackAvailable = false;
        console.warn("NO MEMBERSTACK AVAILABLE, using localStorage", {
            memberstack: !!window.memberstack,
            memberstackDom: !!window.$memberstackDom,
            location: window.location.href
        });
    }
})();

// Language redirect
if (location.pathname == "/") {
    const lang = $lbh.language();
    if (lang != "de") {
        const target = `${location.origin}/${lang}/`;
        console.log("lang-switch", target);
        location.href = target;
    }
}
</script>

<!-- Email Verification Handler -->
<script>
console.log('Initializing LBH verification system...');

async function handleVerification() {
    // Only handle /verify path specifically
    if (window.location.pathname !== '/verify') return;
    
    console.log('Starting verification process');
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    
    if (!token) {
        console.error('No token found in URL parameters:', window.location.search);
        window.location.href = '/verification-error?message=Missing token';
        return;
    }

    try {
        console.log('Attempting verification with token');
        
        // Wait for MemberStack to be initialized using our Promise
        console.log('Waiting for MemberStack initialization...');
        const MS = await $lbh.waitForMemberstack();
        
        if (!MS) {
            console.error('MemberStack initialization failed');
            throw new Error('MemberStack not available');
        }

        console.log('MemberStack initialized successfully');

        // Use v1 verification method
        console.log('Verifying email with token:', token);
        await MS.verifyEmail(token);
        console.log('Verification successful');

        // Get language for redirect
        const lang = $lbh.language();
        window.location.href = lang === 'de' ? '/verification-success' : `/${lang}/verification-success`;
        
    } catch (error) {
        console.error('Verification error:', error);
        const lang = $lbh.language();
        const errorPath = lang === 'de' ? '/verification-error' : `/${lang}/verification-error`;
        window.location.href = `${errorPath}?message=${encodeURIComponent(error?.message || 'Verification failed')}`;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, checking for verification...');
    handleVerification();
});
</script>
