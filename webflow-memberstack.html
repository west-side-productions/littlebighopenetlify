<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MD9FWSRJ');</script>
<!-- End Google Tag Manager -->

<script>
"use strict";

// Language configuration (keep in sync with webflow-memberstack-checkout.js)
const LANGUAGE_CONFIG = {
    supported: ['de', 'en', 'fr', 'it'],
    default: 'de'
};

const $lbh = {
    memberStackAvailable: !(typeof $memberstackDom === 'undefined'),

    // Improved language detection
    language: () => {
        let detectedLanguage = null;
        const debug = {};

        // 1. Try Memberstack (highest priority for logged-in users)
        if ($lbh.memberStackAvailable) {
            try {
                const member = $memberstackDom.getCurrentMember();
                if (member?.data?.customFields?.language) {
                    detectedLanguage = member.data.customFields.language;
                    debug.source = 'memberstack';
                }
            } catch (error) {
                console.warn('Error getting Memberstack language:', error);
            }
        }

        // 2. Try Webflow's current locale
        if (!detectedLanguage) {
            const currentLocaleLink = document.querySelector('.w-locales-item a.w--current');
            if (currentLocaleLink) {
                const hrefLang = currentLocaleLink.getAttribute('hreflang');
                if (hrefLang && LANGUAGE_CONFIG.supported.includes(hrefLang)) {
                    detectedLanguage = hrefLang;
                    debug.source = 'webflow';
                }
            }
        }

        // 3. Try URL path
        if (!detectedLanguage) {
            const pathParts = window.location.pathname.split('/');
            const possibleLang = pathParts[1];
            if (possibleLang && LANGUAGE_CONFIG.supported.includes(possibleLang)) {
                detectedLanguage = possibleLang;
                debug.source = 'url';
            }
        }

        // 4. Try browser language
        if (!detectedLanguage) {
            const browserLang = (navigator.language || navigator.userLanguage || '').split('-')[0].toLowerCase();
            if (LANGUAGE_CONFIG.supported.includes(browserLang)) {
                detectedLanguage = browserLang;
                debug.source = 'browser';
            }
        }

        // 5. Fallback to default
        if (!detectedLanguage || !LANGUAGE_CONFIG.supported.includes(detectedLanguage)) {
            detectedLanguage = LANGUAGE_CONFIG.default;
            debug.source = 'fallback';
        }

        // Log language detection for debugging
        debug.detected = detectedLanguage;
        console.log('Language detection:', debug);

        return detectedLanguage;
    },

    // Helper function to validate language
    validateLanguage: (lang) => {
        return LANGUAGE_CONFIG.supported.includes(lang) ? lang : LANGUAGE_CONFIG.default;
    },

    loadJson: async function loadJson() {
        if (!$lbh.memberStackAvailable) {
            return JSON.parse(localStorage.getItem("json") ?? "{}")
        }

        let json = await $memberstackDom.getMemberJSON()
        console.log("json", json)
        return json?.data ?? {}
    },

    updateJson: async function updateJson(json) {
        if (!$lbh.memberStackAvailable) {
            localStorage.setItem("json", JSON.stringify(json))
            return
        }

        const up = { json: json }
        console.log("json", up)
        await $memberstackDom.updateMemberJSON(up)
    },

    tryfind: function tryfind(selector, parent) {
        return (parent ?? document).querySelector(selector)
    },

    find: function find(selector, parent) {
        const res = $lbh.tryfind(selector, parent)
        if (!res) {
            throw `can't find element by selector '${selector}' in ${parent ?? document}`
        }
        return res
    },

    formatQuantity: function formatQuantity(q) {
        if (!q) return "";

        let nr = Math.floor(q);
        let fract = q - nr;

        // convert fract to string
        switch (fract) {
            case 0:
                fract = "";
                break;
            case 0.25:
                fract = "¼";
                break;
            case 0.5:
                fract = "½";
                break;
        }

        if (nr > 0) {
            return `${nr}${fract}`;
        } else {
            return fract;
        }
    }
}

// debug output
if (!$lbh.memberStackAvailable) {
    console.warn("NO MEMBERSTACK AVALIABLE, using localStorage")
}

// lang switcher
if (location.pathname == "/") {
    const lang = $lbh.language()
    if (lang != "de") {
        const target = `${location.origin}/${lang}/`
        console.log("lang-switch", target)
        location.href = target
    }
}
</script>

<!-- Memberstack Configuration -->
<script>
window.$memberstackDom = {
    debug: true,
    loadTimeout: 15000,
    customDomains: true,
    onReady() {
        console.log("Memberstack ready");
        $lbh.memberStackAvailable = true;
        window.dispatchEvent(new Event('memberstack:initialized'));
    },
    onError(error) {
        console.error("Memberstack error", error);
        $lbh.memberStackAvailable = false;
        window.dispatchEvent(new CustomEvent('memberstack:error', { detail: error }));
    }
};
</script>

<!-- Memberstack Script -->
<script 
    data-memberstack-app="app_cm24j3get009s0spw6wz49psh" 
    src="https://static.memberstack.com/scripts/v1/memberstack.js" 
    type="text/javascript"
    async
></script>

<!-- Verification Handler -->
<script>
(async function init() {
    try {
        // Wait for Memberstack to be ready
        await new Promise((resolve, reject) => {
            if (window.memberstack) {
                resolve();
                return;
            }
            
            window.addEventListener('memberstack:initialized', resolve);
            setTimeout(() => reject(new Error('Memberstack timeout')), 15000);
        });

        // Handle verification if on verify page
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (token && location.pathname.includes('verify')) {
            console.log('Starting verification process...');
            try {
                await window.memberstack.verifyEmail(token);
                console.log('Verification successful');
                
                const lang = $lbh.language();
                window.location.href = lang === 'de' ? '/verification-success' : `/${lang}/verification-success`;
            } catch (error) {
                console.error('Verification error:', error);
                const lang = $lbh.language();
                const errorPath = lang === 'de' ? '/verification-error' : `/${lang}/verification-error`;
                window.location.href = `${errorPath}?message=${encodeURIComponent(error?.message || 'Verification failed')}`;
            }
        }
    } catch (error) {
        console.error('Failed to initialize Memberstack:', error);
        $lbh.memberStackAvailable = false;
        console.warn("NO MEMBERSTACK AVAILABLE, using localStorage");
    }
})();
</script>