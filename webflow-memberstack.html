<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MD9FWSRJ');</script>
<!-- End Google Tag Manager -->

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MD9FWSRJ');</script>
<!-- End Google Tag Manager -->

<!-- Initialize $lbh immediately -->
<script>
// Initialize $lbh globally first
window.$lbh = {
    memberStackAvailable: false,
    
    loadJson: async function() {
        if (!this.memberStackAvailable) {
            return JSON.parse(localStorage.getItem("json") ?? "{}");
        }
        try {
            const member = await window.memberstack.getMemberJSON();
            return member?.data ?? {};
        } catch (e) {
            console.error('Error loading member data:', e);
            return {};
        }
    },

    updateJson: async function(json) {
        if (!this.memberStackAvailable) {
            localStorage.setItem("json", JSON.stringify(json));
            return;
        }
        try {
            await window.memberstack.updateMemberJSON({ json });
        } catch (e) {
            console.error('Error updating member data:', e);
            localStorage.setItem("json", JSON.stringify(json)); // Fallback
        }
    },

    tryfind: function(selector, parent) {
        return (parent ?? document).querySelector(selector);
    },

    find: function(selector, parent) {
        const res = this.tryfind(selector, parent);
        if (!res) {
            throw new Error(`Can't find element by selector '${selector}'`);
        }
        return res;
    },

    formatQuantity: function(q) {
        if (!q) return "";
        let nr = Math.floor(q);
        let fract = q - nr;
        switch (fract) {
            case 0: fract = ""; break;
            case 0.25: fract = "¼"; break;
            case 0.5: fract = "½"; break;
        }
        return nr > 0 ? `${nr}${fract}` : fract;
    },

    language: function() {
        const defaultLang = "de";
        const langs = ["de", "en", "fr", "it"];
        try {
            if (!navigator.language) return defaultLang;
            const langPart = navigator.language.split('-')[0];
            if (!langPart) return defaultLang;
            const i = langs.indexOf(langPart.toLowerCase());
            return i >= 0 ? langs[i] : defaultLang;
        } catch (e) {
            console.error('Error detecting language:', e);
            return defaultLang;
        }
    }
};
</script>

<!-- Memberstack Configuration -->
<script>
window.memberstackOptions = {
    debug: true,
    loadTimeout: 15000,
    customDomains: true,
    onReady: function() {
        console.log('Memberstack initialized successfully');
        window.$lbh.memberStackAvailable = true;
        window.dispatchEvent(new Event('memberstack:initialized'));
    },
    onError: function(error) {
        console.error('Memberstack initialization error:', error);
        window.$lbh.memberStackAvailable = false;
        window.dispatchEvent(new CustomEvent('memberstack:error', { detail: error }));
    }
};
</script>

<!-- Memberstack Script -->
<script 
    data-memberstack-app="app_cm24j3get009s0spw6wz49psh" 
    src="https://static.memberstack.com/scripts/v1/memberstack.js" 
    type="text/javascript"
    async
></script>

<!-- Verification Handler -->
<script>
(async function init() {
    try {
        // Wait for Memberstack to be ready
        await new Promise((resolve, reject) => {
            if (window.memberstack) {
                resolve();
                return;
            }
            
            window.addEventListener('memberstack:initialized', resolve);
            setTimeout(() => reject(new Error('Memberstack timeout')), 15000);
        });

        // Handle verification if on verify page
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (token && location.pathname.includes('verify')) {
            console.log('Starting verification process...');
            try {
                await window.memberstack.verifyEmail(token);
                console.log('Verification successful');
                
                const lang = window.$lbh.language();
                window.location.href = lang === 'de' ? '/verification-success' : `/${lang}/verification-success`;
            } catch (error) {
                console.error('Verification error:', error);
                const lang = window.$lbh.language();
                const errorPath = lang === 'de' ? '/verification-error' : `/${lang}/verification-error`;
                window.location.href = `${errorPath}?message=${encodeURIComponent(error?.message || 'Verification failed')}`;
            }
        }

        // Handle language redirect for root path
        if (location.pathname === "/") {
            const lang = window.$lbh.language();
            if (lang !== "de") {
                const target = `${location.origin}/${lang}/`;
                console.log("Language redirect to:", target);
                window.location.href = target;
            }
        }
    } catch (error) {
        console.error('Failed to initialize Memberstack:', error);
        window.$lbh.memberStackAvailable = false;
        console.warn("NO MEMBERSTACK AVAILABLE, using localStorage");
    }
})();
</script>