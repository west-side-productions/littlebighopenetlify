<script>
// Store the detected language globally so it remains consistent
let detectedLanguage = null;

// Function to detect language from URL first, then browser
function detectLanguage() {
    // If we already detected the language, use that
    if (detectedLanguage) {
        return detectedLanguage;
    }

    // First try from URL path (e.g., /en, /de, /fr, /it)
    const pathLang = window.location.pathname.split('/')[1];
    if (['en', 'de', 'fr', 'it'].includes(pathLang)) {
        detectedLanguage = pathLang;
        console.log('Language detected from URL:', detectedLanguage);
        return detectedLanguage;
    }

    // Then try browser language
    const browserLang = navigator.language.split('-')[0];
    detectedLanguage = ['en', 'de', 'fr', 'it'].includes(browserLang) ? browserLang : 'en';
    console.log('Language detected from browser:', detectedLanguage);
    return detectedLanguage;
}

// Initialize Memberstack functionality
function initializeMemberstack() {
    const language = detectLanguage();
    console.log('Using language for registration:', language);

    // Add hidden language input to signup forms
    const signupForms = document.querySelectorAll('form[data-memberstack-form]');
    signupForms.forEach(form => {
        // Add form submission handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get form data
            const email = form.querySelector('[data-ms-member="email"]').value;
            const password = form.querySelector('[data-ms-member="password"]').value;
            const firstName = form.querySelector('[name="first-name"]')?.value || 'User';

            try {
                // Create member with detected language
                const result = await window.$memberstackDom.createMember({
                    email,
                    password,
                    customFields: {
                        'first-name': firstName,
                        language: language // Use the detected language
                    },
                    sendEmailVerification: false
                });
                
                console.log('Member created with language:', language);

                // Send our custom verification email
                await fetch('https://lillebighopefunctions.netlify.app/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: email,
                        templateName: 'email_verification',
                        language: language,
                        variables: {
                            firstName: firstName,
                            verificationLink: result.verificationUrl || `https://littlebighope.com/verify-email?token=${result.verificationToken}`
                        }
                    })
                });
                
                // Redirect to success page
                if (result?.redirectUrl) {
                    window.location.href = result.redirectUrl;
                }
            } catch (error) {
                console.error('Failed to create member:', error);
            }
        });
    });

    // Handle verification from URL
    const urlParams = new URLSearchParams(window.location.search);
    const verifyToken = urlParams.get('token');
    if (verifyToken && window.location.pathname.includes('verify-email')) {
        window.$memberstackDom.verifyEmail({ token: verifyToken })
            .then(() => {
                window.location.href = '/verification-success';
            })
            .catch(error => {
                console.error('Email verification failed:', error);
            });
    }

    // Set up event handlers
    const setupHooks = () => {
        // Password reset request
        window.$memberstackDom.addHook('passwordReset:requested', ({ member, token }) => {
            // Use the member's stored language preference
            const userLanguage = member?.customFields?.language || language;
            fetch('https://lillebighopefunctions.netlify.app/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: member.auth.email,
                    templateName: 'password_reset',
                    language: userLanguage,
                    variables: {
                        firstName: member.customFields['first-name'] || 'User',
                        resetLink: `https://littlebighope.com/reset-password?token=${token}`
                    }
                })
            }).catch(error => console.error('Failed to send password reset email:', error));
        });

        // Email verification success
        window.$memberstackDom.addHook('emailVerification:success', ({ member }) => {
            // Use the member's stored language preference
            const userLanguage = member?.customFields?.language || language;
            fetch('https://lillebighopefunctions.netlify.app/.netlify/functions/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: member.auth.email,
                    templateName: 'email_verified',
                    language: userLanguage,
                    variables: {
                        firstName: member.customFields['first-name'] || 'User'
                    }
                })
            }).catch(error => console.error('Failed to send verification success email:', error));
        });
    };

    // Initialize hooks
    if (window.$memberstackDom.addHook) {
        setupHooks();
    } else {
        console.log('Waiting for Memberstack hooks to be available...');
        const checkHooks = setInterval(() => {
            if (window.$memberstackDom.addHook) {
                clearInterval(checkHooks);
                setupHooks();
            }
        }, 100);
    }

    // Listen for language changes in the locale nav
    document.querySelectorAll('.w-locales-item a').forEach(link => {
        link.addEventListener('click', () => {
            const newLang = link.getAttribute('hreflang');
            if (newLang) {
                // Update the detected language
                detectedLanguage = newLang;
                console.log('Language updated to:', detectedLanguage);
            }
        });
    });
}

// Wait for Memberstack to be ready
function waitForMemberstack(callback, maxAttempts = 50) {
    let attempts = 0;
    const interval = setInterval(() => {
        attempts++;
        if (window.$memberstackDom) {
            clearInterval(interval);
            callback();
        } else if (attempts >= maxAttempts) {
            clearInterval(interval);
            console.error('Memberstack failed to initialize');
        }
    }, 100);
}

// Initialize when the page loads
window.addEventListener('load', () => {
    waitForMemberstack(initializeMemberstack);
});
</script>
