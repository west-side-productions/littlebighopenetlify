<script>
    // Configuration
    const SUPPORTED_LANGUAGES = ['de', 'en', 'fr', 'it'];
    const DEFAULT_LANGUAGE = 'de';
    let currentUserLanguage = DEFAULT_LANGUAGE; // Use the same default language

    // Get user's browser language
    function detectLanguage() {
        const browserLang = (navigator.language || navigator.userLanguage).split('-')[0].toLowerCase();
        return SUPPORTED_LANGUAGES.includes(browserLang) ? browserLang : DEFAULT_LANGUAGE;
    }

    // Store detected language in select field
    function setupLanguageField() {
        const langSelect = document.querySelector('select[data-ms-field="language"]');
        if (!langSelect) return;

        const browserLang = detectLanguage();
        
        // Check if the detected language is available in the select options
        const options = Array.from(langSelect.options);
        const matchingOption = options.find(option => option.value === browserLang);
        
        if (matchingOption) {
            langSelect.value = browserLang;
            currentUserLanguage = browserLang;
        }

        // Add change listener to update currentUserLanguage
        langSelect.addEventListener('change', (event) => {
            currentUserLanguage = event.target.value;
        });
    }

    // Send custom email using our multi-language system
    async function sendCustomEmail(to, templateName, variables) {
        try {
            console.log('Sending email:', { templateName, language: currentUserLanguage });
            const response = await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to,
                    templateName,
                    language: currentUserLanguage,
                    variables
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to send email');
            }

            return await response.json();
        } catch (error) {
            console.error('Error sending email:', error);
            throw error;
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', setupLanguageField);

    // Wait for Memberstack
    function waitForMemberstack(maxAttempts = 50) {
        if (maxAttempts <= 0) return;
        
        if (window.memberstack) {
            setupMemberstack();
        } else {
            setTimeout(() => waitForMemberstack(maxAttempts - 1), 100);
        }
    }

    // Setup Memberstack
    function setupMemberstack() {
        // Initialize Memberstack 2.0 with configuration
        window.memberstack.initialize({ 
            publicKey: 'pk_sb_0062e297a05a98d62226',
            appPlatformDomain: window.location.origin,
            verificationRedirect: '/membershome',  
            emailVerification: false  
        });

        // Update language when member signs in
        document.addEventListener('memberstack:member:signedIn', async () => {
            const member = await window.memberstack.getCurrentMember();
            if (member) {
                currentUserLanguage = member.customFields?.language || 'en';
            }
        });

        // Handle abandoned cart
        let cartCheckInterval;
        const checkForAbandonedCart = async () => {
            const member = await window.memberstack.getCurrentMember();
            if (member) {
                const cart = localStorage.getItem('cart');
                if (cart && JSON.parse(cart).length > 0) {
                    try {
                        await sendCustomEmail(member.email, 'abandonedCart', {
                            firstName: member.firstName || 'User',
                            cartLink: `${window.location.origin}/cart`,
                            language: member.customFields?.language || currentUserLanguage
                        });
                    } catch (error) {
                        console.error('Failed to send abandoned cart email:', error);
                    }
                }
            }
        };

        // Check for abandoned cart after 24 hours
        document.addEventListener('memberstack:member:signedIn', () => {
            if (cartCheckInterval) clearInterval(cartCheckInterval);
            cartCheckInterval = setInterval(checkForAbandonedCart, 24 * 60 * 60 * 1000);
        });

        const signupForm = document.querySelector('form[data-ms-form]');
        if (signupForm) {
            signupForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const form = event.target;
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;

                try {
                    const email = form.querySelector('input[type="email"]').value;
                    const password = form.querySelector('input[type="password"]').value;
                    const language = form.querySelector('select[data-ms-field="language"]').value || DEFAULT_LANGUAGE;
                    const firstName = form.querySelector('input[data-ms-field="first-name"]')?.value || '';
                    const lastName = form.querySelector('input[data-ms-field="last-name"]')?.value || '';

                    // Update currentUserLanguage to match form selection
                    currentUserLanguage = language;

                    // Use Memberstack 2.0 signup with proper configuration
                    const signupResult = await window.memberstack.signup({
                        email,
                        password,
                        customFields: {
                            language: language,
                            'first-name': firstName,
                            'last-name': lastName
                        },
                        redirectTo: '/membershome',
                        verifyEmail: false
                    });

                    // Get verification URL from Memberstack
                    const verificationUrl = `${window.location.origin}/verify?token=${signupResult.verificationToken}`;

                    // Send our custom verification email
                    await fetch('/.netlify/functions/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to: email,
                            templateName: 'verification',
                            language: language,  
                            variables: {
                                firstName: firstName || 'User',
                                verificationUrl: verificationUrl
                            }
                        })
                    });

                    // Redirect to verification page
                    window.location.href = '/email-verification';
                } catch (error) {
                    console.error('Signup error:', error);
                    submitButton.disabled = false;
                }
            });
        }
    }

    // Start initialization
    waitForMemberstack();
</script>
