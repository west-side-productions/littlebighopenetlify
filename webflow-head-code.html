<script>
// Language configuration
const SUPPORTED_LANGUAGES = ['en', 'de', 'fr', 'it'];
const DEFAULT_LANGUAGE = 'en';

// Detect language from URL path or browser settings
function detectLanguage() {
    // Try to get language from URL path
    const pathSegments = window.location.pathname.split('/').filter(Boolean);
    const pathLanguage = pathSegments[0]?.toLowerCase();
    
    if (SUPPORTED_LANGUAGES.includes(pathLanguage)) {
        console.log('Using URL path language:', pathLanguage);
        return pathLanguage;
    }

    // Try to get language from browser settings
    const browserLanguage = navigator.language || navigator.userLanguage;
    const shortBrowserLang = browserLanguage.split('-')[0].toLowerCase();
    
    if (SUPPORTED_LANGUAGES.includes(shortBrowserLang)) {
        console.log('Using browser language:', shortBrowserLang);
        return shortBrowserLang;
    }

    // Fallback to default language
    console.log('Using default language:', DEFAULT_LANGUAGE);
    return DEFAULT_LANGUAGE;
}

// Wait for Memberstack to be available globally
function waitForMemberstack() {
    return new Promise((resolve) => {
        const checkMemberstack = () => {
            if (window.MemberStack) {
                resolve(window.MemberStack);
            } else {
                setTimeout(checkMemberstack, 100);
            }
        };
        checkMemberstack();
    });
}

async function initializeMemberstack() {
    const language = detectLanguage();
    console.log('Initializing Memberstack with language:', language);

    try {
        // Wait for Memberstack to be available
        const MemberStack = await waitForMemberstack();
        console.log('Memberstack found, initializing...');

        // Initialize Memberstack
        window.$memberstackDom = MemberStack.initialize({
            publicKey: 'pk_sb_0062e297a05a98d62226'
        });

        if (!window.$memberstackDom) {
            throw new Error('Memberstack initialization failed');
        }

        // Wait for Memberstack to be ready
        await window.$memberstackDom.getCurrentMember();
        console.log('Memberstack initialized successfully');
        
        // Get the signup form
        const form = document.querySelector('[data-ms-form="signup"]');
        if (!form) {
            console.warn('Signup form not found - this might be expected if not on signup page');
            return;
        }

        // Ensure form has proper attributes
        form.setAttribute('method', 'post');
        form.setAttribute('data-ms-form', 'signup');
        
        // Set autocomplete attributes
        const emailInput = form.querySelector('[data-ms-member="email"]');
        const passwordInput = form.querySelector('[data-ms-member="password"]');
        
        if (emailInput) {
            emailInput.setAttribute('autocomplete', 'username');
        }
        if (passwordInput) {
            passwordInput.setAttribute('autocomplete', 'new-password');
        }
        
        // Get price element
        const priceElement = document.querySelector('[data-ms-price]');
        if (priceElement) {
            console.log('Price element found:', priceElement.getAttribute('data-ms-price'));
        }

        // Add form submission handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Form submitted!');
            
            try {
                // Get form data
                const email = emailInput?.value;
                const password = passwordInput?.value;
                const firstName = form.querySelector('[name="first-name"]')?.value?.trim() || 'User';
                
                if (!email || !password) {
                    throw new Error('Email and password are required');
                }

                console.log('Creating member with data:', { email, firstName, language });

                // Create member with Memberstack 2.0
                const { data: newMember, error } = await window.$memberstackDom.signup({
                    email,
                    password,
                    redirectUrl: window.location.origin + '/email-verification',
                    customFields: {
                        'first-name': firstName,
                        'language': language,
                        'preferred_language': language
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                console.log('Member created successfully:', newMember);

                // Send verification email with correct language
                const emailData = {
                    to: email,
                    templateName: 'email_verification',
                    language: language,
                    variables: {
                        firstName: firstName,
                        language: language,
                        verificationLink: `${window.location.origin}/verify-email?token=${newMember.loginRedirectUrl.split('token=')[1]}`
                    }
                };

                console.log('Sending verification email with data:', emailData);

                const response = await fetch('https://lillebighopefunctions.netlify.app/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Email API error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('Verification email sent:', result);

                // Redirect to verification page
                window.location.href = `/${language}/email-verification`;

            } catch (error) {
                console.error('Error during signup:', error);
                alert('An error occurred during signup. Please try again.');
            }
        });

        // Handle password reset using Memberstack's built-in hooks
        if (window.$memberstackDom.passwordResetRequested) {
            window.$memberstackDom.passwordResetRequested.subscribe(async ({ member, token }) => {
                try {
                    // Get user's language preference or fallback to current language
                    const userLanguage = member.customFields?.language || language;
                    if (!SUPPORTED_LANGUAGES.includes(userLanguage)) {
                        console.warn(`Unsupported language ${userLanguage}, falling back to ${DEFAULT_LANGUAGE}`);
                        userLanguage = DEFAULT_LANGUAGE;
                    }
                    
                    console.log('Sending password reset email for language:', userLanguage);

                    const emailData = {
                        to: member.auth.email,
                        templateName: 'password_reset',
                        language: userLanguage,
                        variables: {
                            firstName: member.customFields['first-name'] || 'User',
                            language: userLanguage,
                            resetLink: `${window.location.origin}/${userLanguage}/reset-password?token=${token}`
                        }
                    };

                    console.log('Sending password reset email with data:', emailData);

                    const response = await fetch('https://lillebighopefunctions.netlify.app/.netlify/functions/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(emailData)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Email API error: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('Password reset email sent:', result);
                } catch (error) {
                    console.error('Error sending password reset email:', error);
                }
            });
        }

    } catch (error) {
        console.error('Error initializing Memberstack:', error);
    }
}

// Initialize when the page loads
window.addEventListener('load', initializeMemberstack);
</script>
