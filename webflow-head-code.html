<script>
// Immediate startup check
console.log('%c[Debug Check] Script loaded and running', 'background: #ff5722; color: white; padding: 2px 5px; border-radius: 3px;');

// Debug configuration - MUST be at top level
window.LBH_DEBUG = {
    enabled: true,
    log: function(...args) {
        if (this.enabled) {
            console.log('%c[LBH Debug]', 'background: #ffeb3b; color: black; padding: 2px 5px; border-radius: 3px;', ...args);
        }
    },
    error: function(...args) {
        if (this.enabled) {
            console.error('%c[LBH Error]', 'background: #f44336; color: white; padding: 2px 5px; border-radius: 3px;', ...args);
        }
    }
};

// Configuration
const SUPPORTED_LANGUAGES = ['de', 'en', 'fr', 'it'];
const DEFAULT_LANGUAGE = 'de';

// Get user's browser language
function detectLanguage() {
    // Get browser language (returns e.g. 'en-US', 'de-DE', 'it', 'fr')
    const browserLang = (navigator.language || navigator.userLanguage).split('-')[0].toLowerCase();
    
    // If browser language is supported, use it
    if (SUPPORTED_LANGUAGES.includes(browserLang)) {
        return browserLang;
    }
    
    // Default to German
    return DEFAULT_LANGUAGE;
}

// Store detected language in hidden form field
function setupLanguageField() {
    const userLang = detectLanguage();
    const langField = document.querySelector('input[data-ms-lang]');
    if (langField) {
        langField.value = userLang;
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', setupLanguageField);

// Wait for Memberstack to be available
function waitForMemberstack(maxAttempts = 50) {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const check = () => {
            attempts++;
            console.log(`ðŸ”„ Checking for Memberstack (attempt ${attempts}/${maxAttempts})...`);
            
            // Log what we find to help debug
            console.log('Available Memberstack objects:', {
                MemberStack: !!window.MemberStack,
                memberstack: !!window.memberstack,
                $memberstackDom: !!window.$memberstackDom,
                ms: !!window.ms
            });
            
            // Check for any of the possible Memberstack objects
            if (window.MemberStack || window.memberstack || window.$memberstackDom || window.ms) {
                const found = window.MemberStack || window.memberstack || window.$memberstackDom || window.ms;
                console.log('âœ… Found Memberstack object:', found);
                resolve(found);
            } else if (attempts >= maxAttempts) {
                reject(new Error('Memberstack not found after maximum attempts'));
            } else {
                setTimeout(check, 100);
            }
        };
        check();
    });
}

// Wait for DOM to be fully loaded
function waitForDOM() {
    return new Promise(resolve => {
        if (document.readyState === 'complete') {
            console.log('âœ… DOM already loaded');
            resolve();
        } else {
            console.log('â³ Waiting for DOM to load...');
            window.addEventListener('load', () => {
                console.log('âœ… DOM now loaded');
                resolve();
            });
        }
    });
}

// Initialize Memberstack
async function initializeMemberstack() {
    try {
        console.log('ðŸ”„ Starting Memberstack initialization...');
        console.log('Current URL:', window.location.href);
        
        const language = detectLanguage();
        console.log('ðŸŒ Detected language for Memberstack:', language);
        
        // Wait for both Memberstack and DOM to be ready
        const [memberstack] = await Promise.all([waitForMemberstack(), waitForDOM()]);
        
        console.log('ðŸŽ‰ Both Memberstack and DOM are ready!');
        
        // Initialize Memberstack with our configuration
        if (typeof memberstack.initialize === 'function') {
            window.$memberstackDom = memberstack.initialize({
                publicKey: 'pk_sb_0062e297a05a98d62226'
            });
        } else {
            // If initialize isn't available, the object might already be initialized
            window.$memberstackDom = memberstack;
        }
        
        if (!window.$memberstackDom) {
            throw new Error('Memberstack initialization failed');
        }

        // Function to set up forms
        const setupForms = async () => {
            console.log('ðŸ” Starting form setup...');
            
            // Log window object keys to help debug
            console.log('ðŸ”‘ Available window objects:', 
                Object.keys(window)
                    .filter(key => key.toLowerCase().includes('form') || 
                             key.toLowerCase().includes('memberstack'))
            );
            
            // Try multiple selectors in order of preference
            const selectors = [
                '#wf-form-signup',
                'form[data-ms-form="signup"]',
                'form[data-name="Email Form"]',
                'form[data-name="Signup Form"]',
                'form.signup-form',
                'form[data-name="wf-form-signup"]',
                // Add more generic fallbacks
                'form[data-form-type="signup"]',
                'form.w-form'
            ];
            
            // Log all forms on the page first
            const allForms = document.querySelectorAll('form');
            console.log(`ðŸ“ Found ${allForms.length} total forms on page`);
            
            allForms.forEach((form, index) => {
                // Log basic form info
                console.log(`\nðŸ“‹ Form #${index + 1} Details:`, JSON.stringify({
                    id: form.id,
                    name: form.getAttribute('data-name'),
                    class: form.className,
                    msForm: form.getAttribute('data-ms-form'),
                    action: form.action,
                    method: form.method
                }, null, 2));
                
                // Log all attributes
                const formAttrs = Array.from(form.attributes)
                    .map(attr => `${attr.name}="${attr.value}"`)
                    .join('\n');
                console.log(`Form #${index + 1} Attributes:\n${formAttrs}`);
                
                // Log all input fields with detailed info
                const inputs = form.querySelectorAll('input, select, textarea, button');
                console.log(`\nðŸ” Form #${index + 1} Fields:`);
                inputs.forEach((input, fieldIndex) => {
                    const fieldInfo = {
                        tagName: input.tagName.toLowerCase(),
                        type: input.type,
                        name: input.name,
                        id: input.id,
                        class: input.className,
                        placeholder: input.placeholder,
                        required: input.required,
                        value: input.type === 'password' ? '[REDACTED]' : input.value,
                        defaultValue: input.type === 'password' ? '[REDACTED]' : input.defaultValue,
                        attributes: Array.from(input.attributes)
                            .filter(attr => !['type', 'name', 'id', 'class', 'placeholder', 'required', 'value'].includes(attr.name))
                            .map(attr => `${attr.name}="${attr.value}"`)
                            .join(', ')
                    };
                    console.log(`Field #${fieldIndex + 1}:`, JSON.stringify(fieldInfo, null, 2));
                });
                
                // Log form structure with more details
                console.log(`\nðŸŒ³ Form #${index + 1} Structure:`);
                const logElement = (element, depth = 0) => {
                    const indent = '  '.repeat(depth);
                    const elementInfo = {
                        tag: element.tagName.toLowerCase(),
                        id: element.id,
                        class: element.className,
                        type: element.type,
                        name: element.name,
                        attributes: Array.from(element.attributes)
                            .filter(attr => !['id', 'class', 'type', 'name'].includes(attr.name))
                            .map(attr => `${attr.name}="${attr.value}"`)
                            .join(', ')
                    };
                    console.log(indent + 'â””â”€', JSON.stringify(elementInfo));
                    Array.from(element.children).forEach(child => logElement(child, depth + 1));
                };
                logElement(form);
            });
            
            // Try each selector
            let signupForm = null;
            let usedSelector = null;
            
            for (const selector of selectors) {
                console.log(`ðŸ” Trying selector: "${selector}"`);
                const form = document.querySelector(selector);
                if (form) {
                    console.log(`âœ… Found form with selector: "${selector}"`, JSON.stringify({
                        id: form.id,
                        name: form.getAttribute('data-name'),
                        class: form.className,
                        msForm: form.getAttribute('data-ms-form'),
                        action: form.action,
                        method: form.method
                    }, null, 2));
                    signupForm = form;
                    usedSelector = selector;
                    break;
                } else {
                    console.log(`âŒ No form found with selector: "${selector}"`);
                }
            }
            
            if (!signupForm) {
                console.error('âŒ No signup form found with any of these selectors:', selectors);
                return;
            }
            
            console.log('ðŸ”§ Setting up form found with selector:', usedSelector);
            
            // Clone and set up the form
            const newForm = signupForm.cloneNode(true);
            signupForm.parentNode.replaceChild(newForm, signupForm);
            signupForm = newForm;

            // Fix form attributes
            signupForm.setAttribute('method', 'post');
            signupForm.setAttribute('data-ms-form', 'true');
            signupForm.removeAttribute('action'); // Let Memberstack handle the action

            // Get the language selector and update it
            const languageSelect = signupForm.querySelector('#field');
            if (languageSelect) {
                // Fix the name and data attributes
                languageSelect.setAttribute('name', 'language');
                languageSelect.setAttribute('data-ms-member', 'language');
                languageSelect.removeAttribute('data-ms-field'); // Remove duplicate attribute
                
                // Clear existing options
                while (languageSelect.firstChild) {
                    languageSelect.removeChild(languageSelect.firstChild);
                }
                
                // Add normalized options
                const languages = [
                    { value: 'de', text: 'Deutsch' },
                    { value: 'en', text: 'English' },
                    { value: 'fr', text: 'FranÃ§ais' },
                    { value: 'es', text: 'EspaÃ±ol' }
                ];
                
                languages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang.value;
                    option.textContent = lang.text;
                    if (lang.value === (detectLanguage() || 'de')) {
                        option.selected = true;
                    }
                    languageSelect.appendChild(option);
                });
            }

            // Add form submit handler
            signupForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const form = event.target;
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;

                try {
                    // Get form data including language
                    const email = form.querySelector('input[type="email"]').value;
                    const password = form.querySelector('input[type="password"]').value;
                    const language = form.querySelector('input[data-ms-lang]').value || detectLanguage();

                    // Sign up with Memberstack
                    const signupResult = await window.$memberstackDom.signupWithEmail({
                        email,
                        password,
                        customFields: {
                            language: language
                        }
                    });

                    // Send verification email with correct language
                    await fetch('/.netlify/functions/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to: email,
                            templateName: 'verification',
                            language: language,
                            variables: {
                                verificationCode: signupResult.verificationCode
                            }
                        })
                    });

                    // Redirect to verification page
                    window.location.href = '/email-verification';
                } catch (error) {
                    console.error('Signup error:', error);
                    submitButton.disabled = false;
                }
            });
            
            console.log('âœ… Form setup complete');
        };
        
        // Set up forms immediately if DOM is already loaded
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            console.log(' DOM already loaded, setting up forms immediately');
            await setupForms();
        } else {
            // Otherwise wait for DOMContentLoaded
            console.log(' Waiting for DOM to load...');
            document.addEventListener('DOMContentLoaded', setupForms);
        }
        
        console.log(' Memberstack initialization complete');
        return window.$memberstackDom;
    } catch (error) {
        console.error(' Error initializing Memberstack:', error);
        throw error;
    }
}

// Main initialization function
async function initialize() {
    window.LBH_DEBUG.log('Starting initialization...');
    
    try {
        // Initialize Memberstack first
        await initializeMemberstack();
        
        // Log successful initialization
        window.LBH_DEBUG.log('Initialization complete');
    } catch (error) {
        window.LBH_DEBUG.error('Initialization failed:', error);
    }
}

// Start initialization when the page loads
window.addEventListener('load', initialize);

// Log that script has finished loading
window.LBH_DEBUG.log('Script initialization complete');
</script>
