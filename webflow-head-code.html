<script>
    // Configuration
    const SUPPORTED_LANGUAGES = ['de', 'en', 'fr', 'it'];
    const DEFAULT_LANGUAGE = 'de';
    let currentUserLanguage = DEFAULT_LANGUAGE; // Use the same default language

    // Get user's browser language
    function detectLanguage() {
        const browserLang = (navigator.language || navigator.userLanguage).split('-')[0].toLowerCase();
        return SUPPORTED_LANGUAGES.includes(browserLang) ? browserLang : DEFAULT_LANGUAGE;
    }

    // Store detected language in select field
    function setupLanguageField() {
        const langSelect = document.querySelector('select[data-ms-field="language"]');
        if (!langSelect) return;

        const browserLang = detectLanguage();
        
        // Check if the detected language is available in the select options
        const options = Array.from(langSelect.options);
        const matchingOption = options.find(option => option.value === browserLang);
        
        if (matchingOption) {
            langSelect.value = browserLang;
            currentUserLanguage = browserLang;
        }

        // Add change listener to update currentUserLanguage
        langSelect.addEventListener('change', (event) => {
            currentUserLanguage = event.target.value;
        });
    }

    // Send custom email using our multi-language system
    async function sendCustomEmail(to, templateName, variables) {
        try {
            console.log('Sending email:', { templateName, language: currentUserLanguage });
            const response = await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to,
                    templateName,
                    language: currentUserLanguage,
                    variables
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to send email');
            }

            return await response.json();
        } catch (error) {
            console.error('Error sending email:', error);
            throw error;
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', setupLanguageField);

    // Wait for Memberstack
    function waitForMemberstack(maxAttempts = 50) {
        if (maxAttempts <= 0) return;
        
        if (window.$memberstackDom) {
            setupMemberstack();
        } else {
            setTimeout(() => waitForMemberstack(maxAttempts - 1), 100);
        }
    }

    // Setup Memberstack
    async function setupMemberstack() {
        try {
            console.log('Setting up Memberstack...');
            
            // Initialize Memberstack 2.0
            const { client } = await window.$memberstackDom.init({
                publicKey: 'pk_sb_0062e297a05a98d62226',
                customEmailVerification: true  // This is the correct 2.0 setting
            });
            window.memberstack = client;

            // Set up event listeners for forms
            const signupForm = document.querySelector('form[data-ms-form="signup"]');
            if (signupForm) {
                signupForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const form = event.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;

                    try {
                        const email = form.querySelector('input[type="email"]').value;
                        const password = form.querySelector('input[type="password"]').value;
                        const language = form.querySelector('select[data-ms-field="language"]').value || DEFAULT_LANGUAGE;
                        const firstName = form.querySelector('input[data-ms-field="first-name"]')?.value || '';
                        const lastName = form.querySelector('input[data-ms-field="last-name"]')?.value || '';

                        // Update currentUserLanguage to match form selection
                        currentUserLanguage = language;

                        // Use Memberstack 2.0 signup
                        const { data: member, error } = await window.memberstack.members.createMember({
                            email,
                            password,
                            customFields: {
                                language: language,
                                'first-name': firstName,
                                'last-name': lastName
                            }
                        });

                        if (error) throw error;

                        // Send our custom verification email
                        await fetch('/.netlify/functions/send-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                to: email,
                                templateName: 'verification',
                                language: language,
                                variables: {
                                    firstName: firstName || 'User',
                                    verificationUrl: member.loginLink  // Memberstack 2.0 provides this
                                }
                            })
                        });

                        // Redirect to verification page
                        window.location.href = '/email-verification';
                    } catch (error) {
                        console.error('Signup error:', error);
                        submitButton.disabled = false;
                    }
                });
            }
            
            console.log('Memberstack setup complete');
        } catch (error) {
            console.error('Error setting up Memberstack:', error);
        }
    }

    // Start initialization
    waitForMemberstack();
</script>
