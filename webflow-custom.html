<script>
    // Configuration
    const SUPPORTED_LANGUAGES = ['de', 'en', 'fr', 'it'];
    const DEFAULT_LANGUAGE = 'de';
    let currentUserLanguage = DEFAULT_LANGUAGE; // Use the same default language

    // Handle verification routes
    async function handleVerificationRoutes() {
        const path = window.location.pathname;
        const params = new URLSearchParams(window.location.search);

        if (path === '/verify') {
            console.log('Verification page detected');
            const token = params.get('token');
            console.log('Token:', token);
            
            if (!token) {
                console.error('No token found in URL');
                window.location.href = '/verification-error?message=Missing verification token';
                return;
            }

            try {
                console.log('Sending verification request...');
                const verificationUrl = `https://lillebighopefunctions.netlify.app/.netlify/functions/verify-email?token=${token}`;
                console.log('Verification URL:', verificationUrl);
                
                const response = await fetch(verificationUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                const responseData = await response.json();
                console.log('Response data:', responseData);

                if (!response.ok) {
                    throw new Error(responseData.message || 'Verification failed');
                }

                // If verification successful, redirect to success page
                console.log('Verification successful, redirecting...');
                window.location.href = '/verification-success';
            } catch (error) {
                console.error('Verification error details:', error);
                window.location.href = `/verification-error?message=${encodeURIComponent(error.message || 'Verification failed')}`;
            }
        }
    }

    // Get user's browser language
    function detectLanguage() {
        const browserLang = (navigator.language || navigator.userLanguage).split('-')[0].toLowerCase();
        return SUPPORTED_LANGUAGES.includes(browserLang) ? browserLang : DEFAULT_LANGUAGE;
    }

    // Store detected language in select field
    function setupLanguageField() {
        const langSelect = document.querySelector('select[data-ms-field="language"]');
        if (!langSelect) return;

        const browserLang = detectLanguage();
        
        // Check if the detected language is available in the select options
        const options = Array.from(langSelect.options);
        const matchingOption = options.find(option => option.value === browserLang);
        
        if (matchingOption) {
            langSelect.value = browserLang;
            currentUserLanguage = browserLang;
        }

        // Add change listener to update currentUserLanguage
        langSelect.addEventListener('change', (event) => {
            currentUserLanguage = event.target.value;
        });
    }

    // Send custom email using our multi-language system
    async function sendCustomEmail(to, templateName, variables) {
        try {
            console.log('Sending email:', { templateName, language: currentUserLanguage });
            const response = await fetch('/.netlify/functions/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to,
                    templateName,
                    language: currentUserLanguage,
                    variables
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to send email');
            }

            return await response.json();
        } catch (error) {
            console.error('Error sending email:', error);
            throw error;
        }
    }

    // Setup Memberstack
    async function setupMemberstack() {
        try {
            console.log('Setting up Memberstack...');
            
            // Wait for Memberstack to load with improved detection
            const maxWaitTime = 10000; // 10 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
                if (window.memberstack && window.memberstack.isInitialized()) {
                    console.log('Memberstack loaded and initialized');
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 250));
            }
            
            // Check if Memberstack is available
            if (!window.memberstack || !window.memberstack.isInitialized()) {
                throw new Error('Memberstack initialization timeout');
            }

            const ms = window.memberstack;

            // Set up event listeners for forms
            const signupForm = document.querySelector('form[data-ms-form="signup"]');
            if (signupForm) {
                signupForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const form = event.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;

                    try {
                        const email = form.querySelector('input[type="email"]').value;
                        const password = form.querySelector('input[type="password"]').value;
                        const language = form.querySelector('select[data-ms-field="language"]').value || DEFAULT_LANGUAGE;
                        const firstName = form.querySelector('input[data-ms-field="first-name"]')?.value || '';
                        const lastName = form.querySelector('input[data-ms-field="last-name"]')?.value || '';

                        // Update currentUserLanguage to match form selection
                        currentUserLanguage = language;

                        // Use Memberstack signup
                        const result = await ms.signupMember({
                            email,
                            password,
                            data: {
                                language: language,
                                'first-name': firstName,
                                'last-name': lastName
                            }
                        });

                        if (result.error) throw new Error(result.error);

                        // Send our custom verification email
                        await fetch('/.netlify/functions/send-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                to: email,
                                templateName: 'verification',
                                language: language,
                                variables: {
                                    firstName: firstName || 'User',
                                    verificationUrl: result.loginRedirect || '/'
                                }
                            })
                        });

                        // Redirect to verification page
                        window.location.href = '/email-verification';
                    } catch (error) {
                        console.error('Signup error:', error);
                        submitButton.disabled = false;
                    }
                });
            }
            
            console.log('Memberstack setup complete');
        } catch (error) {
            console.error('Error setting up Memberstack:', error);
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        setupLanguageField();
        handleVerificationRoutes();
        setupMemberstack();
    });
</script>
